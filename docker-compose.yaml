version: '3.8'
services:
  camera-app:
    image: javohirgo/smile-mini-pc-app:smile.v1.1.9
    container_name: camera-streaming-app
    restart: unless-stopped
    privileged: true
    network_mode: host
    ports:
      - "8765:8765"
      - "8554:8554"  # MediaMTX RTSP port
      - "9997:9997"  # MediaMTX API port
      - "9998:9998"  # MediaMTX metrics port
    volumes:
      # Keep only these safe volume mounts
      - ./logs:/app/logs
      - ./data:/app/data
      - /dev:/dev
      # REMOVE these lines that cause permission issues:
      # - ./videos:/app/videos
      # - ./temp_videos:/app/temp_videos
    devices:
      # Allow access to video devices for camera detection
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
    environment:
      - PYTHONPATH=/app
      - HOST_MAC=${HOST_MAC}
      - OPENCV_VIDEOIO_PRIORITY_MSMF=0
      - CUDA_VISIBLE_DEVICES=""
      - OPENCV_DNN_BACKEND=0
      - MPLBACKEND=Agg
      - LIBGL_ALWAYS_INDIRECT=1
      # Application-specific
      - ENABLE_WEBSOCKET=true
      - WEBSOCKET_PORT=8765
      - WEBSOCKET_QUALITY=100
      - WEBSOCKET_MAX_FPS=30
      - VIDEO_GENERATION_ENABLED=true
      - VIDEO_TRIGGER_EMOTIONS=upset,smile,normal
      - FFMPEG_ENABLED=true
      - OPENCV_FFMPEG_CAPTURE_OPTIONS=protocol_whitelist;file,rtp,udp
      - PYTHONMALLOC=malloc
      - MALLOC_TRIM_THRESHOLD_=100000
      # Camera management settings
      - ENABLE_LOCAL_CAMERA_DETECTION=true
      - MEDIAMTX_PORT=8554
      - MEDIAMTX_API_PORT=9997
      - MEDIAMTX_METRICS_PORT=9998
    
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    # deploy:
    #   resources:
    #     limits:
    #       memory: 6G
    #       cpus: '3.0'
    #     reservations:
    #       memory: 1G
    #       cpus: '1.0'
